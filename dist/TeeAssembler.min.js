const TeeAssembler={randomID:(e=16)=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let i="";for(let a=0;a<e;a++){const e=Math.floor(52*Math.random());i+=t.substring(e,e+1)}return i},skin:{size:{width:256,height:128},elements:{body:[0,0,96,96],body_shadow:[96,0,96,96],hand:[192,0,32,32],hand_shadow:[224,0,32,32],foot:[192,32,64,32],foot_shadow:[192,64,64,32],credits:[0,96,64,32],default_eye:[64,96,32,32],angry_eye:[96,96,32,32],blink_eye:[128,96,32,32],happy_eye:[160,96,32,32],cross_eye:[192,96,32,32],surprised_eye:[224,96,32,32]}},array:{tees:[],teeIDs:[]}};{class e{constructor(e={}){TeeAssembler.array.tees.push(this),e.imageLink=e.imageLink||"https://ddnet.org/skins/skin/default.png",this.api={functions:{...this.functions},teeEyesVariables:!1,image:{element:new Image,loaded:!1}},delete this.functions,this.api.image.element.crossOrigin="",this.api.image.link=e.imageLink,this.eyesAngle=0,this.bodyColor=e.bodyColor||void 0,this.feetColor=e.feetColor||void 0,this.colorFormat=e.colorFormat||void 0;let t=e.ID||TeeAssembler.randomID();for(;TeeAssembler.array.teeIDs.includes(t)||document.getElementById(t);)t=TeeAssembler.randomID();this.ID=t,TeeAssembler.array.teeIDs.push(this.ID),this.api.functions.setContainer=async e=>{if(!e instanceof HTMLElement)throw Error("Invalid element: container is not of type HTMLElement");this.container=e,this.container.dataset.teeassemblerId=this.ID;const t=document.createDocumentFragment();this.api.functions.createAndAppendTeeElements(t,"teeassembler-eyes_guide_line",!1),this.api.functions.createAndAppendTeeElements(t,"teeassembler-eyes_guide_marker",!1,".teeassembler-eyes_guide_line"),this.api.functions.createAndAppendTeeElements(t,"teeassembler-body_shadow",!0),this.api.functions.createAndAppendTeeElements(t,"teeassembler-back_foot_shadow",!0),this.api.functions.createAndAppendTeeElements(t,"teeassembler-back_foot",!0),this.api.functions.createAndAppendTeeElements(t,"teeassembler-body",!0),this.api.functions.createAndAppendTeeElements(t,"teeassembler-eyes",!1),this.api.functions.createAndAppendTeeElements(t,"teeassembler-left_eye",!0,".teeassembler-eyes"),this.api.functions.createAndAppendTeeElements(t,"teeassembler-right_eye",!0,".teeassembler-eyes"),this.api.functions.createAndAppendTeeElements(t,"teeassembler-front_foot_shadow",!0),this.api.functions.createAndAppendTeeElements(t,"teeassembler-front_foot",!0),this.container.appendChild(t);const i=document.createElement("style");this.api.image.url||(this.container.getAttribute("data-teeassembler-color_body")&&this.container.getAttribute("data-teeassembler-color_feet")?await this.api.functions.getTeeImage(this.container.getAttribute("data-teeassembler-color_body"),this.container.getAttribute("data-teeassembler-color_feet"),this.container.getAttribute("data-teeassembler-color_format")||"code"):this.bodyColor&&this.feetColor?await this.api.functions.getTeeImage(this.bodyColor,this.feetColor,this.colorFormat):await this.api.functions.getTeeImage()),i.textContent=`\n\t\t\t\t\t.teeassembler-tee[data-teeassembler-id='${this.ID}'] div[data-teeassembler-body_part] {\n\t\t\t\t\t\tbackground-image: url(${this.api.image.url});\n\t\t\t\t\t\tbackground-size: 256em 128em;\n\t\t\t\t\t}`;const a=document.querySelectorAll(`.teeassembler-tee[data-teeassembler-id='${this.ID}'] style`);a&&a.forEach((e=>{e.remove()})),this.container.appendChild(i),this.api.functions.lookAt(this.eyesAngle)},e.container&&this.api.functions.setContainer(e.container)}functions={loadImage:async e=>{this.api.image.element.src=e,await this.api.image.element.decode(),this.api.canvas="OffscreenCanvas"in window?new OffscreenCanvas(0,0):document.createElement("canvas"),this.api.canvas.width=this.api.image.element.width,this.api.canvas.height=this.api.image.element.height,this.api.ctx=this.api.canvas.getContext("2d",{willReadFrequently:!0}),this.api.ctx.drawImage(this.api.image.element,0,0,this.api.canvas.width,this.api.canvas.height),this.api.image.loaded=!0},setColor:async(e,t,i,a)=>{const s=t.data,n=new Color(0,0,0,0);for(let e=0;e<s.length;e+=4)n.r=s[e],n.g=s[e+1],n.b=s[e+2],n.a=s[e+3],COLOR_MODE[a](n,i),s[e]=n.r,s[e+1]=n.g,s[e+2]=n.b,s[e+3]=n.a;this.api.functions.setCanvas(e,s)},reorderBody:async(e,t)=>{const i=t.data,a=Array(256).fill(0),s=192;let n,o=0;for(n=0;n<i.length;n+=4)i[n+3]>128&&a[i[n]]++;for(let e=1;e<256;e++)a[o]<a[e]&&(o=e);const r=255-o;for(n=0;n<i.length;n+=4){let e=i[n];e<=o&&0==o||(e=e<=o?Math.trunc(e/o*s):0==r?s:Math.trunc((e-o)/r*63+s),i[n]=e,i[n+1]=e,i[n+2]=e)}this.api.functions.setCanvas(e,i)},createCanvas:(e=0,t=0)=>{const i="OffscreenCanvas"in window?new OffscreenCanvas(0,0):document.createElement("canvas");return i.width=e,i.height=t,i},setCanvas:(e,t)=>{e.putImageData(new ImageData(t,e.canvas.width,e.canvas.height),0,0)},createAndAppendTeeElements:(e,t,i,a)=>{const s=document.createElement("div");s.className=t,i&&s.setAttribute("data-teeassembler-body_part",""),a?e.querySelector(a).appendChild(s):e.appendChild(s)},getBlob:async e=>{let t;return t=e instanceof OffscreenCanvas?await e.convertToBlob():await new Promise((t=>{e.toBlob(t)})),t},isRatioLegal:()=>this.api.image.element.width/this.api.image.element.height==TeeAssembler.skin.size.width/TeeAssembler.skin.size.height,getMultiplier:()=>this.api.image.element.width/TeeAssembler.skin.size.width,getColorArg:(e,t)=>{if(0==Object.keys(COLOR_FORMAT).includes(t))throw Error(`Invalid color format: ${t}\nValid formats: rgb, hsl, code`);return e=COLOR_FORMAT[t](e)},colorLimitForSkin:(e,t=52.5)=>(e[2]<t&&(e[2]=t),e),colorConvert:(e,t)=>(e=this.api.functions.getColorArg(e,t),"rgb"==t&&(e=RGBToHSL(e[0],e[1],e[2])),e=this.api.functions.colorLimitForSkin(e),e=HSLToRGB(e[0],e[1],e[2]),new Color(...e)),setColor2:async(e,t,i,a,s)=>{e||(e=this.ctx),t=this.api.functions.colorConvert(t,i),await this.api.functions.setColor(e,a,t,"grayscale"),"body"===s&&await this.api.functions.reorderBody(e,a),await this.api.functions.setColor(e,a,t,"default")},getTeeImage:async(e="none",t="none",i="code")=>{if(await this.api.functions.loadImage(this.api.image.link),!this.api.functions.isRatioLegal())throw new Error("Image has wrong ratio.");const a=this.api.functions.getMultiplier(),s=Object.keys(TeeAssembler.skin.elements);this.colorFormat=i||"code";for(const n in s){const o={};this.partMultiplied=TeeAssembler.skin.elements[s[n]].map((e=>e*a)),o[n]=this.api.functions.createCanvas(this.partMultiplied[2],this.partMultiplied[3]);const r=o[n].getContext("2d");r.putImageData(this.api.ctx.getImageData(this.partMultiplied[0],this.partMultiplied[1],this.partMultiplied[2],this.partMultiplied[3]),0,0),this.api.image.data=r.getImageData(0,0,this.partMultiplied[2],this.partMultiplied[3]),"none"!==e&&"none"!==t&&(s[n].includes("foot")?await this.api.functions.setColor2(r,t,i,this.api.image.data,s[n]):s[n].includes("credits")||await this.api.functions.setColor2(r,e,i,this.api.image.data,s[n])),this.api.ctx.clearRect(this.partMultiplied[0],this.partMultiplied[1],this.partMultiplied[2],this.partMultiplied[3]),this.api.ctx.drawImage(o[n],this.partMultiplied[0],this.partMultiplied[1])}this.api.canvas instanceof OffscreenCanvas?this.api.ctx.drawImage(this.api.canvas.transferToImageBitmap(),0,0):this.api.ctx.drawImage(await createImageBitmap(this.api.ctx.getImageData(0,0,this.api.canvas.width,this.api.canvas.height)),0,0);const n=await this.api.functions.getBlob(this.api.canvas);return this.api.image.url=URL.createObjectURL(n),delete this.partMultiplied,this.api.image.url},bindContainer:e=>{this.api.functions.setContainer(e)},unbindContainer:(e=!1)=>{this.api.functions.dontLookAtCursor(),Object.keys(this.container.dataset).forEach((e=>{delete this.container.dataset[e]})),e?(URL.revokeObjectURL(this.api.image.url),this.api.image.loaded=!1,this.container.remove()):this.container.replaceChildren(),delete this.container},teeEyesTranslateFunction:()=>{this.api.markerCoord={x:this.api.marker.getBoundingClientRect().x,y:this.api.marker.getBoundingClientRect().y},this.api.scale=this.container.getBoundingClientRect().width/this.container.offsetWidth*Number(window.getComputedStyle(TeeAssembler.array.tees[0].container).fontSize.replace("px","")),this.api.teeEyes.style.transform=`translate(${(this.api.markerCoord.x-this.container.getBoundingClientRect().x)/this.api.scale}em, ${(this.api.markerCoord.y-this.container.getBoundingClientRect().y)/this.api.scale}em)`},setTeeEyesVariables:()=>{this.api.teeEyesVariables=!0,this.api.line=document.querySelector(`.teeassembler-tee[data-teeassembler-id='${this.ID}'] .teeassembler-eyes_guide_line`),this.api.marker=document.querySelector(`.teeassembler-tee[data-teeassembler-id='${this.ID}'] .teeassembler-eyes_guide_marker`),this.api.teeEyes=document.querySelector(`.teeassembler-tee[data-teeassembler-id='${this.ID}'] .teeassembler-eyes`)},lookAtCursor:()=>{this.api.functions.setTeeEyesVariables(),this.api.functions.moveTeeEyesFunction=e=>{const t=this.container.getBoundingClientRect().x+this.container.getBoundingClientRect().width/2,i=this.container.getBoundingClientRect().y+this.container.getBoundingClientRect().height/2;this.eyesAngle=180*Math.atan2(e.clientY-i,e.clientX-t)/Math.PI,this.api.line.style.width=9.5-Math.sin(Math.PI/180)*this.api.functions.roundToMultiple(this.eyesAngle)*2+"em",this.api.line.style.transform=`translate(-1em, .5em) rotate(${this.eyesAngle}deg)`,this.api.functions.teeEyesTranslateFunction()},document.addEventListener("mousemove",this.api.functions.moveTeeEyesFunction)},dontLookAtCursor:()=>{document.removeEventListener("mousemove",this.api.functions.moveTeeEyesFunction)},lookAt:(e=0)=>{this.eyesAngle=e,this.api.functions.setTeeEyesVariables(),this.api.line.style.width=9.5-Math.sin(Math.PI/180)*this.api.functions.roundToMultiple(e)*2+"em",this.api.line.style.transform=`translate(-1em, .5em) rotate(${e}deg)`,this.api.teeEyes.style.transform="translate(56.5em, 48.5em)",this.api.functions.teeEyesTranslateFunction()},roundToMultiple:(e=0,t=180)=>{const i=Math.round(e/t)*t;return Math.abs(e-i)}}}TeeAssembler.Tee=e}document.querySelectorAll(".teeassembler-tee[data-teeassembler-autoload]").forEach((e=>{options={container:e,imageLink:e.getAttribute("data-teeassembler-skin_image"),bodyColor:e.getAttribute("data-teeassembler-color_body"),feetColor:e.getAttribute("data-teeassembler-color_feet"),colorFormat:e.getAttribute("data-teeassembler-color_format")},new TeeAssembler.Tee(options)}));
//# sourceMappingURL=teeassembler.min.js.map